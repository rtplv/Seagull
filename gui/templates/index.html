{% extends '_base_layout.html' %}
{% load static %}

{% block title %}Seagull - Supervisord Monitor{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'styles/index.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
    <div class="groups-list" id="app">
        <input type="text" class="group-filter form-control" placeholder="Поиск" v-model="search">

        <div class="card group" v-for="(group, name) in filteredProcessGroups">
            <table class="table">
                <caption style="caption-side: top">
                    <div class="caption-wrapper">
                        <i class="fas fa-circle"
                           :class="[ someProcessWorking(group) ? 'text-success': 'text-danger' ]"
                        ></i>

                        <span class="group-name">[[ name ]]</span>

                        <div class="group-actions">
                            <button type="button"
                                    v-if="!someProcessWorking(group)"
                                    class="btn btn-outline-success btn-sm">
                                Запустить
                            </button>
                            <template v-else>
                                <button type="button"
                                        class="btn btn-outline-primary btn-sm">Перезапустить</button>

                                <button type="button"
                                        class="btn btn-outline-danger btn-sm">Остановить</button>
                            </template>
                        </div>
                    </div>
                </caption>
                <thead>
                    <tr>
                        <th>Состояние</th>
                        <th>Название</th>
                        <th>Время запуска</th>
                        <th>Время остановки</th>
                        <th class="actions-head">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="process in group">
                        <td class="state-cell">
                            <span class="badge badge-pill"
                                  :title="process.state.description"
                                  :class="{
                                    'badge-success': process.state.color === 'green',
                                    'badge-warning': process.state.color === 'yellow',
                                    'badge-danger': process.state.color === 'red',
                                  }">
                                [[ process.state.title ]]
                            </span>
                        </td>
                        <td>[[ process.name ]]</td>
                        <td>[[ humanizeDate(process.start) ]]</td>
                        <td>[[ humanizeDate(process.stop) ]]</td>
                        <td class="actions-cell">
                            <button type="button"
                                    v-if="process.state.name !== 'RUNNING' && process.statename !== 'STARTING'"
                                    @click="startProcess(process.name)"
                                    class="btn btn-success btn-sm">
                                <i class="fas fa-play"></i>
                            </button>
                            <button type="button"
                                    v-if="process.state.name !== 'STOPPED'"
                                    @click="stopProcess(process.name)"
                                    class="btn btn-primary btn-sm">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button type="button"
                                    v-if="process.state.name !== 'STOPPED'"
                                    @click="stopProcess(process.name)"
                                    class="btn btn-danger btn-sm">
                                <i class="fas fa-stop"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{#    TODO: возможно это стоит вынести в base_layout#}
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <script>
        var vm = new Vue({
            delimiters: ['[[', ']]'],
            el: '#app',
            data: {
                search: '',
                processGroups: {{ process_groups|safe }}
            },
            computed:{
              filteredProcessGroups() {
                  var re = new RegExp(this.search)
                  var self = this

                  return Object.keys(this.processGroups).reduce(function (agg, pgKey) {
                      if (re.test(pgKey)) {
                          agg[pgKey] = self.processGroups[pgKey]
                          return agg
                      }

                      var hits = self.processGroups[pgKey].filter(function (p) {
                         return re.test(p.name)
                      })

                      if (hits.length > 0) {
                          agg[pgKey] = hits
                      }

                      return agg;
                  }, {})
              }
            },
            methods: {
                startProcess(processName) {
                    axios.post('/api/start_process', { params: { process_name: processName }})
                        .then(function (response) {
                            console.log(response)
                        })
                },
                stopProcess(processName) {
                    axios.post('/api/stop_process', { params: { process_name: processName }})
                        .then(function (response) {
                            console.log(response)
                        })
                },
                humanizeDate(ts) {
                    return moment(ts * 1000).format('DD.MM.YY HH:mm:ss')
                },
                someProcessWorking(group) {
                    return group.some(p => p.state.name === 'RUNNING')
                }
            }
        })
    </script>
{% endblock %}